#!/bin/bash

if [ "$EUID" -ne 0 ]; then
  echo "Please run as root or using sudo"
  exit
fi

# The check isnt working I will fix this later...... maybe....
#echo "Checking if Gradle and dos2unix are installed..."
#if ! command -v gradle &> /dev/null; then
#    echo "Gradle not found, please install it and try again"
#    exit 1
#fi

#if ! command -v dos2unix &> /dev/null; then
#    echo "dos2unix not found, please install it and try again"
#    exit 1
#fi

if [ -f .env ]; then
  echo ".env file found. Updating..."
else
  echo "Copying env-example to .env..."
  cp env-example .env
fi

echo "Discord API Key (press enter to skip): "
read discord_api_key
if [ -n "$discord_api_key" ]; then
  sed -i "s/discordkey/$discord_api_key/g" .env
fi

echo "Youtube API Key (press enter to skip): "
read youtube_api_key
if [ -n "$youtube_api_key" ]; then
  sed -i "s/youtubeapikey/$youtube_api_key/g" .env
fi

echo "Discord Webhook URL (press enter to skip): "
read webhook_url
if [ -n "$webhook_url" ]; then
  sed -i "s/quotechannel/$webhook_url/g" .env
fi

echo "Bot Owner's Discord ID (press enter to skip): "
read owner_id
if [ -n "$owner_id" ]; then
  sed -i "s/ownerid/$owner_id/g" .env
fi

echo "Do you want to change the prefix? (y/n): "
read change_prefix
if [ "$change_prefix" == "y" ]; then
  echo "What prefix do you want to use?"
  read new_prefix
  sed -i "s/t-/$new_prefix/g" .env
fi

echo "Building Trexbot"
sudo chmod +x ./gradlew
if ! command -v dos2unix &> /dev/null; then
  echo "dos2unix not found. Exiting..."
  exit 1
fi
dos2unix ./gradlew
./gradlew clean runShadow
mv build/install/Trexbot-shadow/bin/* bin
rm -rf lib
mv build/install/Trexbot-shadow/lib lib
echo "Done building Trexbot"

echo "Do you want to install the provided systemd script (trexbot.service)? (y/n): "
read install_systemd
if [ "$install_systemd" == "y" ]; then
  echo "Enter the user for the service: "
  read service_user
  sed -i "s/User=.*/User=$service_user/g" trexbot.service
  echo "Enter the group for the service: "
  read service_group
  sed -i "s/Group=.*/Group=$service_group/g" trexbot.service
  echo "Copying trexbot.service to /etc/systemd/system/..."
  sudo cp trexbot.service /etc/systemd/system/
  echo "Do you want the bot to start on system startup? (y/n): "
  read start_on_startup
  if [ "$start_on_startup" == "y" ]; then
    echo "Enabling trexbot.service on system startup..."
    sudo systemctl enable trexbot.service
  fi
fi

